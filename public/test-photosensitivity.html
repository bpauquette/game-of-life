<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game of Life - Photosensitivity Test</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 { color: #00ff00; border-bottom: 2px solid #00ff00; padding-bottom: 10px; }
        .instructions {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #00aaff;
        }
        .test-controls {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            border-radius: 4px;
        }
        button:hover { background: #00cc00; }
        button.primary { background: #00aaff; }
        #results {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-size: 12px;
            max-height: 500px;
            overflow-y: auto;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            line-height: 1.5;
        }
        .test-status {
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #00ff00;
            background: #2a2a2a;
            font-size: 14px;
        }
        .test-status.passed { border-left-color: #00ff00; }
        .test-status.failed { border-left-color: #ff3333; }
        code {
            background: #000;
            padding: 2px 6px;
            border-radius: 3px;
            color: #00ff00;
        }
    </style>
</head>
<body>
    <h1>üß™ Game of Life - Photosensitivity Safety Test</h1>
    
    <div class="instructions">
        <h2>üìã Testing Instructions</h2>
        <p><strong>This tool tests if the Game of Life animation meets WCAG 2.1 accessibility standards for photosensitive seizure prevention.</strong></p>
        
        <h3>Quick Test (Browser Console):</h3>
        <ol>
            <li>Open the main Game of Life page (click "Return to App" below)</li>
            <li>Press <code>F12</code> to open browser console</li>
            <li>Copy and paste the test script (click button below)</li>
            <li>Wait 10 seconds for automatic analysis</li>
            <li>Review PASS/FAIL result in console</li>
        </ol>
        
        <h3>What This Tests:</h3>
        <ul>
            <li>‚úÖ <strong>Flash Rate:</strong> Max 3 flashes per second (WCAG 2.1 Level A)</li>
            <li>‚úÖ <strong>Flash Area:</strong> Flashing area ‚â§ 87,296 pixels (341√ó256 rectangle)</li>
            <li>‚úÖ <strong>Luminance Changes:</strong> ITU-R BT.1702 relative luminance calculations</li>
        </ul>
        
        <h3>Legal Compliance:</h3>
        <p>‚öñÔ∏è Meeting WCAG 2.1 Level A provides <strong>safe harbor protection</strong> under ADA regulations. Violations may result in legal liability for photosensitive seizures.</p>
    </div>
    
    <div class="test-controls">
        <h2>üöÄ Quick Actions</h2>
        
        <button class="primary" onclick="backToApp()">
            üéÆ Return to App
        </button>
        
        <button onclick="copyScript()">
            üìã Copy Console Test Script
        </button>
        
        <button onclick="showInstructions()">
            üìñ Show Instructions
        </button>
    </div>
    
    <div id="status" class="test-status">
        Ready. Click "Copy Console Test Script" to get started.
    </div>
    
    <div id="results">
        Select an option above to begin.
    </div>

    <script>
        function backToApp() {
            window.location.href = '/';
        }

        function updateStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'test-status ' + (type || 'info');
        }

        function displayResults(title, content) {
            const results = document.getElementById('results');
            results.innerHTML = '<strong>' + title + ':</strong><br/><br/>' + 
                content.replace(/\n/g, '<br/>').replace(/  /g, '&nbsp;&nbsp;');
        }

        function copyScript() {
            // The improved test script that waits for canvas and tries multiple selectors
            const script = '(function(){class LivePhotosensitivityTest{constructor(){this.canvas=null;this.ctx=null;this.frames=[];this.flashEvents=[];this.startTime=0;this.testDuration=10000;this.sampleInterval=33;this.maxFlashRate=3;this.maxFlashArea=87296}async waitForCanvas(timeout=5000){const start=Date.now();while(Date.now()-start<timeout){this.canvas=document.querySelector("canvas");if(this.canvas)return true;await new Promise(r=>setTimeout(r,100))}return false}async start(){console.log("üß™ Starting photosensitivity test...");console.log("‚è≥ Waiting for canvas element...");const found=await this.waitForCanvas();if(!found){console.error("‚ùå No canvas found after 5 seconds");console.log("Please ensure the Game of Life simulation is running");return}console.log("‚úÖ Canvas found!");this.ctx=this.canvas.getContext("2d");this.startTime=Date.now();const intervalId=setInterval(()=>{this.captureFrame()},this.sampleInterval);setTimeout(()=>{clearInterval(intervalId);this.analyze()},this.testDuration)}captureFrame(){try{const imageData=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height);this.frames.push({timestamp:Date.now(),data:imageData})}catch(e){console.warn("Frame capture failed:",e)}}detectFlash(prevFrame,currFrame){if(!prevFrame||!currFrame)return null;const prev=prevFrame.data.data;const curr=currFrame.data.data;let flashPixels=0;for(let i=0;i<prev.length;i+=4){const prevL=(0.2126*prev[i]+0.7152*prev[i+1]+0.0722*prev[i+2])/255;const currL=(0.2126*curr[i]+0.7152*curr[i+1]+0.0722*curr[i+2])/255;const delta=Math.abs(currL-prevL);if(delta>0.08){flashPixels++}}if(flashPixels>1000){return{timestamp:currFrame.timestamp,flashPixels:flashPixels}}return null}analyze(){console.log("üìä Analyzing "+this.frames.length+" captured frames...");for(let i=1;i<this.frames.length;i++){const flash=this.detectFlash(this.frames[i-1],this.frames[i]);if(flash){this.flashEvents.push(flash)}}const oneSecondAgo=Date.now()-1000;const recentFlashes=this.flashEvents.filter(f=>f.timestamp>oneSecondAgo);const flashRate=recentFlashes.length;const maxFlashArea=Math.max(...this.flashEvents.map(f=>f.flashPixels),0);const flashRateViolation=flashRate>this.maxFlashRate;const flashAreaViolation=maxFlashArea>this.maxFlashArea;const wcagCompliant=!flashRateViolation&&!flashAreaViolation;const report=this.getReport(wcagCompliant,flashRate,maxFlashArea,flashRateViolation,flashAreaViolation);console.log(report);window.__PHOTOSENSITIVITY_REPORT__=report;return report}getReport(compliant,rate,area,rateViolation,areaViolation){const border="=".repeat(60);let report=border+"\\n";report+="  PHOTOSENSITIVITY TEST RESULTS\\n";report+=border+"\\n\\n";if(compliant){report+="‚úÖ RESULT: PASS - Animation is WCAG 2.1 Level A compliant\\n"}else{report+="‚ùå RESULT: FAIL - WCAG 2.1 violations detected\\n"}report+="\\nüìä MEASUREMENTS:\\n";report+="  Flash Rate: "+rate+"/sec (limit: "+this.maxFlashRate+"/sec) ";report+=rateViolation?"‚ùå VIOLATION\\n":"‚úÖ\\n";report+="  Flash Area: "+area+" pixels (limit: "+this.maxFlashArea+" px) ";report+=areaViolation?"‚ùå VIOLATION\\n":"‚úÖ\\n";report+="  Frames Analyzed: "+this.frames.length+"\\n";report+="  Flash Events: "+this.flashEvents.length+"\\n";if(!compliant){report+="\\n‚ö†Ô∏è  RECOMMENDATIONS:\\n";if(rateViolation){report+="  ‚Ä¢ Reduce animation speed to max 2 fps\\n";report+="  ‚Ä¢ Implement frame delay between updates\\n"}if(areaViolation){report+="  ‚Ä¢ Reduce visible grid size (less than 50x50 cells)\\n";report+="  ‚Ä¢ Use gradual transitions instead of instant changes\\n"}report+="\\n‚öñÔ∏è  LEGAL STATUS: HIGH RISK - Not ADA compliant\\n"}else{report+="\\n‚öñÔ∏è  LEGAL STATUS: LOW RISK - Safe harbor protection\\n"}report+="\\n"+border;return report}}const test=new LivePhotosensitivityTest();test.start();console.log("‚è≥ Test running for 10 seconds... Please wait...");})();';
            
            navigator.clipboard.writeText(script).then(() => {
                updateStatus('‚úÖ Script copied! Paste into browser console (F12) on the app page', 'passed');
                displayResults('SUCCESS', 'Script copied to clipboard!\n\n' +
                    'IMPORTANT: The script waits up to 5 seconds for the canvas.\n\n' +
                    'NEXT STEPS:\n' +
                    '1. Click "Return to App" button\n' +
                    '2. MAKE SURE THE SIMULATION IS RUNNING\n' +
                    '3. Press F12 to open Developer Console\n' +
                    '4. Paste the script and press ENTER\n' +
                    '5. Wait 10 seconds for results\n' +
                    '6. Review results in console\n\n' +
                    'Expected results:\n' +
                    '  ‚úÖ PASS = WCAG 2.1 compliant (safe)\n' +
                    '  ‚ùå FAIL = Violations detected (legal risk)');
            }).catch(err => {
                updateStatus('‚ùå Copy failed - please try manual copy below', 'failed');
                displayResults('ERROR', 'Auto-copy to clipboard failed.\n\n' +
                    'Manual copy: Select the script text below and use Ctrl+C\n\n' +
                    'Script:\n' + script);
            });
        }

        function showInstructions() {
            const instructions = 
                'WCAG 2.1 PHOTOSENSITIVITY TEST\n' +
                '='.repeat(60) + '\n\n' +
                'WHAT IT TESTS:\n' +
                '  ‚Ä¢ Flash Rate: Maximum 3 flashes per second\n' +
                '  ‚Ä¢ Flash Area: Maximum 87,296 pixels of flashing\n' +
                '  ‚Ä¢ Luminance: Rapid brightness changes detection\n\n' +
                'WHY IT MATTERS:\n' +
                '  ‚Ä¢ Flashing >3/sec can trigger photosensitive seizures\n' +
                '  ‚Ä¢ ADA (Americans with Disabilities Act) requires compliance\n' +
                '  ‚Ä¢ WCAG 2.1 Level A provides safe harbor legal protection\n' +
                '  ‚Ä¢ Violations create legal liability risk\n\n' +
                'HOW TO TEST:\n' +
                '  1. Open Game of Life app\n' +
                '  2. Start a simulation\n' +
                '  3. Press F12 ‚Üí Console tab\n' +
                '  4. Paste the test script\n' +
                '  5. Press ENTER\n' +
                '  6. Wait 10 seconds\n' +
                '  7. Check results:\n' +
                '     - PASS: Safe to use\n' +
                '     - FAIL: Needs optimization\n\n' +
                'IF TEST FAILS:\n' +
                '  ‚Ä¢ Reduce animation speed (2 fps max)\n' +
                '  ‚Ä¢ Decrease visible grid size\n' +
                '  ‚Ä¢ Use gradual color transitions\n' +
                '  ‚Ä¢ Add Safe Mode toggle for users\n\n' +
                'LEGAL COMPLIANCE:\n' +
                '  ‚úì PASS test = WCAG 2.1 Level A compliant\n' +
                '  ‚úì Safe harbor protection under ADA\n' +
                '  ‚úó FAIL test = Legal liability for seizures\n' +
                '  ‚úó Warning alone increases liability risk\n\n' +
                '='.repeat(60);
            
            updateStatus('üìñ Instructions displayed below', 'info');
            displayResults('PHOTOSENSITIVITY TESTING GUIDE', instructions);
        }
    </script>
</body>
</html>
